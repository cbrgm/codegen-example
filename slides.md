---
theme: ./path/to/theme.json
author: Chris Bargmann
date: MMMM dd, YYYY
paging:  (%d)
---

# Exploring Code Generation with Templating in Go

ðŸ‘¨â€ðŸ’» __Christian Bargmann (cbrgm)__

ðŸ¦ @chrisbargmann

---

# What are we going to cover?

* Understand what code generation is
* Examine the basic parts of a code generator
* Look at some (un)popular code generators
* See how we can add code generation to our dev workflow
* Write a simple code generator

...and hopefully we can do all this in 20 min! :D 

---

# So what's code generation?

> `Code generation` is the process of generating code


> `Code generators` are entities that generate code

---

# What is a code generator?

> `Code generation` is the process of generating code


> `Code generators` are entities that generate code

## You are a code generator!

* You are very creative
* You are a smart problem solver
* No seriously, you really rock producing code!
* but you are slow... and bad at repetitive tasks!

---

# What is a code generator?

> `Code generation` is the process of generating code


> `Code generators` are entities that generate code

## Programs are code generators!

* Computers are able to write computer programs
* (2022) not yet as creative as humans, suffer problem solving abilities
* fast! Good at doing repetitive tasks!

---

# Cool, but how does code generation look like?

```
â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚INPUTâ”œâ”€â”€â”€â–ºâ”‚GENERATORâ”œâ”€â”€â”€â–ºâ”‚OUTPUTâ”‚
â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜
```

### Input

* Code, Metadata, Environment Variables, Configuration Files, None...

### GENERATOR

??? Â¯\_(ãƒ„)_/Â¯

### OUTPUT

* Go, JSON, XML, YAML, Python, Clojure, Kotlin, Ruby, Java, PNG, GIF, MP4, ...

---

# But today we will focus on go-based code generation

```
â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚GO   â”œâ”€â”€â”€â–ºâ”‚GENERATORâ”œâ”€â”€â”€â–ºâ”‚GO    â”‚
â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜
```

### Input

* Go

### Generator

* An executable written in Go

### Output

* Go

---

# Examples of code generators

* go test
```bash
- In: `*_test.go` Go source files
- Out: `package`main` test program source file
```
* [openapi-generator](https://github.com/OpenAPITools/openapi-generator)
```bash
- In: OpenAPI Spec (v2, v3)
- Out: API client libraries (SDK generation), server stubs, documentation and configuration
```
* [Protobuf compiler](https://developers.google.com/protocol-buffers/)
```bash
- In: *.proto definition files
- Out: API client libraries (SDK generation), server stubs to be used with gRPC (https://grpc.io/)
```
* [stringer](https://golang.org/x/tools/cmd/stringer)
```
- In: type declarations in your Go code
- Out: A given `String()` method for those type declarations

More details in a second! :D 
```

---

# Let's check out stringer:

* [stringer](https://golang.org/x/tools/cmd/stringer)

> Stringer is a tool to automate the creation of methods that satisfy the fmt.Stringer interface. Given the name of a (signed or unsigned) integer type T that has constants defined, stringer will create a new self-contained Go source file implementing:

```go
func (t T) String() string
```

TLDR:

* Input: `stringer` takes the name of an integer (`int`) type `T` that has constants defined as __input__
* Output: A Go source file implementing the function signature above

---

# stringer: input

```go
package main

import (
	"fmt"
)

type Genre int

const (
	horror Genre = iota
	fantasy
	crime
	drama
	comedy
)

func main() {
	fmt.Printf("Let's watch a %v movie today!", horror)
}
```

Output:

```bash
go run genres.go
Let's watch a 0 movie today!
```

---

# stringer: input

How can be satisfy the `fmt.Stringer` interface?

```go
func (g Genre) String() string {
    // todo(cbrgm): implement me :(
}
```

```go
// String returns the iota's string representation
func (g Genre) String() string {
	switch g {
	case horror:
		return "horror"
	case comedy:
		return "comedy"
    // pretty repetitive huh...?
	default:
		return ""
	}
}
```

Output:

```bash
go run genres.go
Let's watch a horror movie today!
```

---

# stringer: code generator

Let's generate it!

```
go install  golang.org/x/tools/cmd/stringer
stringer -type=Genre

genre_string.go // I'm generated! :D 
genres.go
```

---

# stringer: output

```go
// Code generated by "stringer -type=Genre"; DO NOT EDIT.

package main

import "strconv"

func _() {
	// An "invalid array index" compiler error signifies that the constant values have changed.
	// Re-run the stringer command to generate them again.
	var x [1]struct{}
	_ = x[horror-0]
	_ = x[fantasy-1]
	_ = x[crime-2]
	_ = x[drama-3]
	_ = x[comedy-4]
}

const _Genre_name = "horrorfantasycrimedramacomedy"

var _Genre_index = [...]uint8{0, 6, 13, 18, 23, 29}

func (i Genre) String() string {
	if i < 0 || i >= Genre(len(_Genre_index)-1) {
		return "Genre(" + strconv.FormatInt(int64(i), 10) + ")"
	}
	return _Genre_name[_Genre_index[i]:_Genre_index[i+1]]
}
```

---

## stringer: output

```go
package main

import (
	"fmt"
)

type Genre int

const (
	horror Genre = iota
	fantasy
	crime
	drama
	comedy
)


func main() {
	fmt.Printf("Let's watch a %v movie today!", horror)
}
```

Output:

```bash
go run genres.go
Let's watch a horror movie today!
```

---

## Cool, but do I always have to run stringer by hand?

No! Go Tooling speeds up our workflow! `go generate` helps us to automate the process of running code generators by scanning comments in your Go source code and find commands to execute

```go
//go:generate stringer -type=Genre
```
We can run `go generate with a list of packages like this:

```bash
go generate ./...
```

Check out `go generate -h`

```bash
usage: go generate [-run regexp] [-n] [-v] [-x] [build flags] [file.go... | packages]
Run 'go help generate' for details.
```

Gotchas:
* `go generate` is not part of `go build`!

---

## stringer: output

```go
package main

import (
	"fmt"
)

type Genre int

const (
	horror Genre = iota
	fantasy
	crime
	drama
	comedy
)

//go:generate stringer -type=Genre
func main() {
	fmt.Printf("Let's watch a %v movie today!", horror)
}
```

Output:

```bash
go run genres.go
Let's watch a horror movie today!
```

---
